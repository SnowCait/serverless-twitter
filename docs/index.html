<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Serverless Twitter</title>
    <style>
      #tweet > textarea[name="text"] {
        height: 5em;
        width: 30em;
        padding: 0.5em;
      }
    </style>
    <script defer>
      const apiUrl = 'https://cjsn785yed.execute-api.ap-northeast-1.amazonaws.com';
      const clientId = 'NnduMzZ5bnk4T1RfT21BdkJlZUg6MTpjaQ';
      const redirectUrl = location.origin + location.pathname;
      const state = randomString(10);
      const verifier = randomString(43);
      console.log('[redirect URL]', redirectUrl);
      console.log('[verifier]', verifier);

      window.addEventListener('DOMContentLoaded', async event => {
        console.log('[DOMContentLoaded]')

        document.getElementById('title').addEventListener('click', event => {
          console.log('[title clicked]', event);
          location.href = redirectUrl
        });

        const signin = document.getElementById('signin');
        signin.addEventListener('click', event => {
          console.log('[signin.clicked]', event);

          const authorizeUrl = constructAuthorizeUrl();
          console.log('authorize URL', authorizeUrl);
          document.cookie = `${state}&${verifier}; max-age=3600`;
          console.log('[cookie]', document.cookie, state);
          window.location.href = authorizeUrl;
        });
        // if (localStorage.getItem('user')) {
        //   signin.disabled = true;
        // }

        document.getElementById('tweet').addEventListener('submit', async event => {
          console.log('[tweet.submitted]', event);

          event.preventDefault();
          const submitter = event.submitter;
          submitter.disabled = true;

          const user = localStorage.getItem('user');
          console.log('[user]', user);

          if (!user) {
            console.error('[unauthorized]');
            event.submitter.disabled = false;
            return;
          }

          const { id: userId, access_token: accessToken } = JSON.parse(user);

          const form = event.target;
          const text = form.elements.text.value;

          const response = await fetch(`${apiUrl}/tweet`, {
            method: 'POST',
            headers: {
              'Authorization': `${userId}:${accessToken}`,
            },
            body: JSON.stringify({
              userId,
              accessToken,
              text,
            }),
          });

          if (!response.ok) {
            console.error('[tweet failed]', response);
            submitter.disabled = false;
            return;
          }

          console.log('[tweeted]', response);

          form.reset();
          submitter.disabled = false;
        });

        const params = new URLSearchParams(location.search);
        const newState = params.get('state');
        const code = params.get('code');
        if (newState && code) {
          console.log('[params]', newState, code);

          const [ savedState, savedVerifier ] = document.cookie.split('&');
          console.log('[cookie]', document.cookie, savedState, savedVerifier);
          if (newState === savedState) {
            const user = await getAccessToken(clientId, code, redirectUrl, savedVerifier);
            console.log('[token]', user);
            localStorage.setItem('user', JSON.stringify(user));
          }
        }
      });

      function constructAuthorizeUrl() {
        let url = 'https://twitter.com/i/oauth2/authorize';
        url += '?response_type=code';
        url += `&client_id=${clientId}`;
        url += `&redirect_uri=${redirectUrl}`;
        url += '&scope=tweet.read tweet.write users.read';
        url += `&state=${state}`;
        url += `&code_challenge=${verifier}`;
        url += '&code_challenge_method=plain';
        return encodeURI(url);
      }

      async function getAccessToken(clientId, code, redirectUrl, verifier) {
        const url = `${apiUrl}/auth`;
        console.log('[fetch]', url);
        const response = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({
            code,
            verifier,
            redirectUrl,
          }),
        });

        if (!response.ok) {
          throw Error('Cannot get access token.');
        }

        return await response.json();
      }

      function randomString(minDigit) {
        let string = '';
        while (string.length < minDigit) {
          string += Math.random().toString(36).substring(2);
        }
        return string;
      }
    </script>
  </head>
  <body>
    <h1 id="title">Serverless Twitter</h1>
    <button id="signin">Sign in with Twitter</button>
    <form id="tweet">
      <textarea placeholder="いまどうしてる？" name="text" required></textarea>
      <input type="submit" value="Tweet">
    </form>
  </body>
</html>
